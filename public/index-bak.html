<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="styles/page-styles.css" rel="stylesheet" type="text/css">
  <link href="styles/endpoints.css" rel="stylesheet" type="text/css">
  <link href="styles/makeListEditable.css" rel="stylesheet" type="text/css">
  <link href="styles/api-response.css" rel="stylesheet" type="text/css">
  <style>

    .multiselect-dropdown, .multiselect-dropdown * {
    
    }
  </style>
  <title>GetHub — Query the GitHub API</title>
 
</head>
<body>


<div id="endpoints">
  <div id="endpoints-menu" class="picker full-width">
    <h2 style="margin:0">&nbsp;GitHub API GET Endpoints</h2>
    
  </div>
  
  
  <div id="endpoints_selectors" class="full-width height-auto clearfix">
    <div class="third-width">

      <label for="Sort_by_select" >Sort by <em>a</em> then <em>b</em> then <em>c</em> then <em>d</em></label>
      <select name="Sort_by_select" id="Sort_by_select" style="width: 17.1em;"
        placeholder="Select a 'Sort By' Option"
        onchange="console.log('Sort_by_select', this.selectedOptions)">
        <!-- js -->
      </select>

      <label for="Sort_dir_select" style="display: block;">Sort Directions</label>
      <select name="Sort_dir_select" id="Sort_dir_select" style="width: 17.1em;"
        placeholder="Select Sort Directions"
        onchange="console.log('Sort_dir_select', this.selectedOptions)">
        <!-- js -->
      </select>
      
      <label for="show_categories_select" style="display: block;">Show Categories</label>
      <select name="show_categories_select" id="show_categories_select" style="width: 267px;"
        multiple multiselect-search="true" 
        multiselect-select-all="true" 
        multiselect-max-items="10" placeholder="Select Categories to Show">
        <!-- js -->
      </select>

      <label for="show_apis_select" style="display: block; overflow: visible;">Show APIs</label>
      <select name="show_apis_select" id="show_apis_select" style="width: 267px;"
        multiple multiselect-search="true" 
        multiselect-select-all="true" 
        multiselect-max-items="100" placeholder="Select APIs to Show"
        onchange="console.log('show_apis_select', this.selectedOptions)">
        <!-- js -->
      </select>

    </div>
    <div class="third-width" style="margin-left: 8em;">

      <label for="show_params_select" style="display: block;">Required Parameters</label>
      <select name="show_params_select" id="show_params_select" style="width: 377px;"
        multiple multiselect-search="true" 
        multiselect-select-all="true" 
        multiselect-max-items="1000" placeholder="Show by Required Parameters"
        onchange="console.log('show_categories_select', this.selectedOptions)">
        <!-- js -->
      </select>

      <label for="require_params_select" style="display: block;">Require Parameters?</label>
      <select name="require_params_select" id="require_params_select" style="width: 377px;"
        placeholder="Select an Option"
        onchange="console.log('Sort_dir_select', this.selectedOptions)">
        <!-- js -->
      </select>

      

    </div>
 
  </div>
  
  <div id="endpointGET" class="full-width float-left"> 
    <!-- <li> will  be inserted and later on, each will have some filter rules -->
    <ol id="endpointGET-ol"></ol>
    <br>
    <button id="endpointGET-submit" style="border: 0.5px solid #64b67b;">
      <strong><code >GET</code></strong>
    </button>
  </div>
</div>





<div id="api-response" class="data-linkify full-width">
</div>
<script type="module" src="module.js"></script>
<script src="js/helpers.js"></script>
<script src="js/multiselect-dropdown.js"></script>
<script src="endpoints/endpoints.js"></script>
<script src="api-response/renderjson.js"></script>
<script src="api-response/linkify.js"></script>
<script src="makeListEditable/makeListEditable.js"></script>

<script>




function selectedEndpointsToQueryString(endpoints_list, pushState=true) {
  // needs pushQueryString (in helpers.js)
  endpoints_list ??= document.getElementById('endpointGET-ol')
  const query_string = '?endpoint=' + [...endpoints_list.querySelectorAll('li')].map(li=>{
    const user_values = [...li.querySelectorAll('span > span[contenteditable')].map(editable => {
      return `"${editable.innerText}"`
    }).join(',')
    return `${li.getAttribute('endpoint')}(${user_values})`

  }).join('&endpoint=')
  if (query_string.length > 10) {
    if (pushState) pushQueryString(query_string)
    return query_string
  }
  return ''
}

function parseQueryStringEndpoints(list_el_to_populate=false, get=false) {
  // needs parseQueryMixed (in helpers.js) and (various) (in endpoints.js)
  // console.log(`parseQueryStringEndpoints(${list_el_to_populate}, ${get})`)
  if (!window.location.search) return
  let {endpoint: endpts} = parseQueryMixed(window.location.search)
  if (!Array.isArray(endpts)) {
    endpts = [endpts]
  }
  endpts = endpts.map(endpt => {
    const [endpoint, ...editables] = endpt.split(/\("|","|"\)/).filter(Boolean)
    return { endpoint, editables: [...editables], is_template: !!editables.join('').trim()}
  })

  if (list_el_to_populate) {
    // console.log('populating endpoints to GET list')
    if (list_el_to_populate === true) {
      list_el_to_populate = document.getElementById('endpointGET-ol') // default if true
    }
    for (const endpt of endpts) {
      if (endpt.is_template) {
        clickApiEndpointTemplate(endpt.endpoint)
        const editables = list_el_to_populate.querySelectorAll(`li:last-of-type > span.endpoint > span[contenteditable]`)
        editables.forEach((editable, idx) => {
          editable.innerText = endpt.editables[idx] || ''
        })
      }
      else clickApiEndpointValid(endpt.endpoint)
    }
    if (get) {
      handleClickGET(...[,false]) // false means don't update query string
    }
  } 
  return endpts
}

function makeEndpointsSelectors(max_sorts=3) {
  // this must be called after endpointsMenuSettings is called (and endpointsMenuSettings.options are set)
  // and should not be called more than once!
  // About max_sorts: there are actually 4 possible (endpointsMenuSettings.options.Sort.length). TODO: try with 4



  const select = {
    Sort_by: document.getElementById('Sort_by_select'),
    Sort_dir: document.getElementById('Sort_dir_select'),
    'Show.Category': document.getElementById('show_categories_select'),
    'Show.API': document.getElementById('show_apis_select'),
    'Show.Parameters.selections': document.getElementById('show_params_select'),
    'Show.Parameters.Require': document.getElementById('require_params_select'),
  }



  // Show: { 
  //   Category: [...endpoints_json.categories],
  //   API: Object.keys(endpoints_json.apis),
  //   Parameters: {
  //     selections: ["None", ...endpoints_json.parameters],
  //     Require: ['Any'], 
  //   },
  // },
  // Sort: [ 'Category ▲', 'Parameters ▼', 'API ▼'],



  appendSortOptions(max_sorts)
  appendShowOptions()


  for (const key in select) {

    select[key].addEventListener('change', event => {
      const htmlCollection = event.target.selectedOptions; // does not work with this.
      let selected_obj = {};

      if (htmlCollection) {
        let selected = [...htmlCollection].map(option_el => option_el.innerText)

        // get the right place in endpointsMenuSettings.selected to put selected_options:
        const props = key.split('.')

        if (props.length === 1){
          // endpointsMenuSettings.selected.Sort
          const [ , which ] = props[0].split('_');
          if (which === 'by') {
            console.log(`Sort by change to `);
          }
          else if (which === 'dir') {
            console.log(`Sort direction change`);
          }
        } else {
          // endpointsMenuSettings.selected.Show...
          
          selected_obj.Show = {};
          if (props[1] === 'Parameters') {
            selected_obj.Show.Parameters = { [props[2]]: selected }
          } else {
            selected_obj.Show[props[1]] = selected;
          }
          console.log(JSON.stringify(selected_obj, null, 2))

        }
      }
      refreshEndpointsMenuContents(selected_obj)
      
    });

  }


  function appendSortOptions(max_sorts=3) {
    // About max_sorts: there are actually 4 possible (endpointsMenuSettings.options.Sort.length). TODO: try with 4
    const directions = [
      bisect(endpointsMenuSettings.options.Sort[0][0], 0, 1)[1],
      bisect(endpointsMenuSettings.options.Sort[0][1], 0, 1)[1]
    ]
    const sortables = endpointsMenuSettings.options.Sort.map( option =>  option[0].slice(0,-2) );
    const preventSectionHell = perm => {
      const sliced = perm.slice(0,2).join('')
      const include = !perm.slice(0,2).join('').includes('Endpoint')
      // console.log(`${perm} = sliced: ${sliced} ? ${include}`)
      return include;
    }

    const sort_options_data = permuteChooseR(sortables, max_sorts, preventSectionHell).sort();
    const direction_options_data = combinationsWithReps(directions,4);
    // console.log(direction_options_data)

    let sort_options_html = sort_options_data.map( sorts => {
      // const selected_by_default = 
      return `<option>`+sorts.join(' ')+`</option>`
    });

    let direction_options_html = direction_options_data.map(dirs => {
      return `<option>&nbsp;&nbsp;`+dirs.join('&nbsp;'.repeat(10))+`</option>`
    });
    // console.log(Array.isArray(sort_options_html))
    // console.log(direction_options_html)


    
    select.Sort_by.innerHTML = sort_options_html.join('\n');
    select.Sort_dir.innerHTML = direction_options_html.join('\n');


    /*
    sort_options = [
      [ 'API', 'Category', 'Endpoint', 'Parameters' ],
      [ 'API', 'Category', 'Parameters', 'Endpoint' ],
      [ 'API', 'Parameters', 'Category', 'Endpoint' ],
      [ 'API', 'Parameters', 'Endpoint', 'Category' ],
      [ 'Category', 'API', 'Endpoint', 'Parameters' ],
      [ 'Category', 'API', 'Parameters', 'Endpoint' ],
      [ 'Category', 'Parameters', 'API', 'Endpoint' ],
      [ 'Category', 'Parameters', 'Endpoint', 'API' ],
      [ 'Parameters', 'API', 'Category', 'Endpoint' ],
      [ 'Parameters', 'API', 'Endpoint', 'Category' ],
      [ 'Parameters', 'Category', 'API', 'Endpoint' ],
      [ 'Parameters', 'Category', 'Endpoint', 'API' ]
    ]

    direction_options[
      [ '▼', '▼', '▼', '▼' ],
      [ '▼', '▼', '▼', '▲' ],
      [ '▼', '▼', '▲', '▲' ],
      [ '▼', '▲', '▲', '▲' ],
      [ '▲', '▲', '▲', '▲' ]
    ]

    */

  }

  function appendShowOptions() {

    /* Show: {
      Category: endpoints_json.categories,  // an array: multiple selections but not none
      API: Object.keys(endpoints_json.apis),// an array: multiple selections but not none
      Parameters: {
        Require: ['Any', 'All'], // user picks one
        selections: ["None", ...endpoints_json.parameters],// an array: multiple selections, allow all and none
      }
    } */
    const {
      Category: categories, 
      API: apis, 
      Parameters: {
        Require: params_require,
        selections: params
      }
    } = endpointsMenuSettings.options.Show;

    const option = opt => `<option>${opt}</option>`

    select['Show.Category'].innerHTML = categories.map(opt => option(opt)).join('\n');
    select['Show.API'].innerHTML = apis.map(opt => option(opt)).join('\n');
    select['Show.Parameters.selections'].innerHTML = params.map(opt => option(opt)).join('\n');
    select['Show.Parameters.Require'].innerHTML = params_require.map(opt => option(opt)).join('\n');
  }
  
}

//// GLOBALS ////////////////////


var endpoints_json = window.endpoints_json; // set in public/module.js

// all of these are set in public/endpoints.js:
var //endpointsMenuSettings = {},
    // selectEndpoints.endpoints = [], // this is endpoints_json.endpoints, filtered and sorted
    selected_URLs, // used cleaning up endpoints menu when selection is made
    responses, // really only used in async function handleClickGET, but could be used for showing errors better 
    rendered_json;  // combined GET responses as full object (no arrays)


//// Start Execution ////////////////////

document.addEventListener("DOMContentLoaded", function() {



  refreshEndpointsMenuContents( /* selected */ ) // without arg, default become fallback_defaults

  makeEndpointsSelectors(4)
    
  makeEndpointsMenuCollapsible()
  setupEndpointsMenuSelection(clickApiEndpointValid, clickApiEndpointTemplate)
  makeListEditable(document.getElementById('endpointGET-ol'))
  parseQueryStringEndpoints(true, true)  
  document.getElementById('endpointGET-submit').addEventListener('click', handleClickGET)

});
  
</script>
</body>
</html>