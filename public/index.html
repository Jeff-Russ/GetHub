<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="css-compiled/page-styles.css" rel="stylesheet" type="text/css">
  <link href="css-compiled/endpoints.css" rel="stylesheet" type="text/css">
  <link href="css-compiled/makeListEditable.css" rel="stylesheet" type="text/css">
  <link href="css-compiled/api-response.css" rel="stylesheet" type="text/css">
  
  <title>GetHub â€” Query the GitHub API</title>
 
</head>
<body>


<div id="endpoints">
  <div id="endpoints-menu" class="picker full-width">
    <h2 style="margin:0">&nbsp;GitHub API GET Endpoints</h2>
    
  </div>
  <div id='endpoint_count' class="full-width height-auto clearfix" style="color: rgb(159, 175, 138);">
  </div>
  
  <div id="endpoints_selectors" class="full-width height-auto clearfix">
    
    <div class="third-width">

      <label for="Sort_by_select" >Sort by <em>a</em> then <em>b</em> then <em>c</em> then <em>d</em></label>
      <select name="Sort_by_select" id="Sort_by_select" style="width: 17.1em;"
        placeholder="Select a 'Sort By' Option">
        <!-- js -->
      </select>

      <label for="Sort_dir_select" style="display: block;">Sort Directions</label>
      <select name="Sort_dir_select" id="Sort_dir_select" style="width: 17.1em;"
        placeholder="Select Sort Directions">
        <!-- js -->
      </select>
      
      <label for="show_categories_select" style="display: block;">Show Categories</label>
      <select name="show_categories_select" id="show_categories_select" style="width: 267px;"
        multiple multiselect-search="false" 
        multiselect-select-all="true" 
        multiselect-max-items="10" placeholder="Select Categories to Show">
        <!-- js -->
      </select>

      <label for="show_apis_select" style="display: block; overflow: visible;">Show APIs</label>
      <select name="show_apis_select" id="show_apis_select" style="width: 267px;"
        multiple multiselect-search="true" 
        multiselect-select-all="true" 
        multiselect-max-items="100" placeholder="Select APIs to Show">
        <!-- js -->
      </select>

    </div>
    
    <div class="third-width" style="margin-left: 8em;">

      <label for="show_params_select" style="display: block;">Required Parameters</label>
      <select name="show_params_select" id="show_params_select" style="width: 377px;"
        multiple multiselect-search="true" 
        multiselect-select-all="true" 
        multiselect-max-items="1000" placeholder="Show by Required Parameters">
        <!-- js -->
      </select>

      <label for="require_params_select" style="display: block;">Require Parameters?</label>
      <select name="require_params_select" id="require_params_select" style="width: 377px;"
        placeholder="Select an Option">
        <!-- js -->
      </select>

      

    </div>
 
  </div>
  
  <div id="endpoints-get" class="full-width float-left"> 
    <!-- <li> will  be inserted and later on, each will have some filter rules -->
    <ol id="endpoints_get_list"></ol>
    <br>
    <button id="endpoints-get-submit" style="border: 0.5px solid #468a59;">
      <strong><code >GET</code></strong>
    </button>
  </div>
</div>





<div id="api-response" class="data-linkify full-width">
</div>
<!-- <script src="json-module.js" type="module" ></script> -->
<script src="data/endpoints_json.js" ></script>
<script src="data/github_org_json.js" ></script>
<script src="js-compiled/helpers.js"></script>
<script src="js-compiled/multiselect-dropdown.js"></script>
<script src="js-compiled/endpoints.js"></script>
<script src="js-compiled/renderjson.js"></script>
<script src="js-compiled/makeListEditable.js"></script>

<script>



function selectedEndpointsToQueryString(endpoints_list, pushState=true) {
  // needs pushQueryString (in helpers.js)
  endpoints_list ??= document.getElementById('endpoints_get_list')
  const query_string = '?endpoint=' + [...endpoints_list.querySelectorAll('li')].map(li=>{
    const user_values = [...li.querySelectorAll('span > span[contenteditable')].map(editable => {
      return `"${editable.innerText}"`
    }).join(',')
    return `${li.getAttribute('endpoint')}(${user_values})`

  }).join('&endpoint=')
  if (query_string.length > 10) {
    if (pushState) pushQueryString(query_string)
    return query_string
  }
  return ''
}

function parseQueryStringEndpoints(list_el_to_populate=false, get=false) {
  // needs parseQueryMixed (in helpers.js) and (various) (in endpoints.js)
  // console.log(`parseQueryStringEndpoints(${list_el_to_populate}, ${get})`)
  if (!window.location.search) return
  let {endpoint: endpts} = parseQueryMixed(window.location.search)
  if (!Array.isArray(endpts)) {
    endpts = [endpts]
  }
  endpts = endpts.map(endpt => {
    const [endpoint, ...editables] = endpt.split(/\("|","|"\)/).filter(Boolean)
    return { endpoint, editables: [...editables], is_template: !!editables.join('').trim()}
  })

  if (list_el_to_populate) {
    // console.log('populating endpoints to GET list')
    if (list_el_to_populate === true) {
      list_el_to_populate = document.getElementById('endpoints_get_list') // default if true
    }
    for (const endpt of endpts) {
      if (endpt.is_template) {
        addEndpointTemplateToGETList(endpt.endpoint)
        const editables = list_el_to_populate.querySelectorAll(`li:last-of-type > span.endpoint > span[contenteditable]`)
        editables.forEach((editable, idx) => {
          editable.innerText = endpt.editables[idx] || ''
        })
      }
      else addEndpointValidToGETList(endpt.endpoint)
    }
    if (get) {
      handleClickGET(...[,false]) // false means don't update query string
    }
  } 
  // console.log(JSON.stringify(endpts,null,2))
  return endpts
}

function makeEndpointsSelectors(max_sorts=3) {
  // this must be called after endpointsMenuSettings is called (and endpointsMenuSettings.options are set)
  // and should not be called more than once!
  // About max_sorts: there are actually 4 possible (endpointsMenuSettings.options.Sort.length). TODO: try with 4


  const select = {
    Sort_by: document.getElementById('Sort_by_select'),
    Sort_dir: document.getElementById('Sort_dir_select'),
    'Show.Category': document.getElementById('show_categories_select'),
    'Show.API': document.getElementById('show_apis_select'),
    'Show.Parameters.selections': document.getElementById('show_params_select'),
    'Show.Parameters.Require': document.getElementById('require_params_select'),
  }


  appendSortOptions(max_sorts)
  appendShowOptions()


  for (const key in select) {

    select[key].addEventListener('change', event => {
      const htmlCollection = event.target.selectedOptions; // does not work with this.
      let selected_obj = {};

      if (htmlCollection) {
        let selected = [...htmlCollection].map(option_el => option_el.innerText)

        // get the right place in endpointsMenuSettings.selected 
        const ksplit = key.split('_') // to put selected_options:

        if (ksplit.length === 2) { // endpointsMenuSettings.selected['Sort']
          let sort_setting = [...endpointsMenuSettings.selected.Sort]
          const selected_sorts = selected[0].trim().split(/\s+/);
          const len = Math.min(selected.length, sort_setting.length)
          if (ksplit[1] === 'by') {
            for (let i = 0; i < len; i++) {
              sort_setting[i] =  selected_sorts[i] + sort_setting[i].slice(-2)
            }
          } else { //if (ksplit[1] === 'dir') {
            for (let i = 0; i < len; i++) {
              sort_setting[i] = sort_setting[i].slice(0, -1) + selected_sorts[i]
            }
          }
          selected_obj.Sort = sort_setting
          console.log(`currently:\n${[...endpointsMenuSettings.selected.Sort]} Sort by change to:\n${sort_setting}`);
        }
        else { // endpointsMenuSettings.selected['Show.*']
            selected_obj[key] = selected;
          // console.log('selected_obj:',JSON.stringify(selected_obj, null, 2))
        }
      }
      refreshEndpointsMenuContents(selected_obj)
      makeEndpointsMenuCollapsible()
      setupEndpointsMenuSelection(addEndpointValidToGETList, addEndpointTemplateToGETList)
      makeListEditable(document.getElementById('endpoints_get_list'))
      
    });

  }


  function appendSortOptions(max_sorts=3) {
    // About max_sorts: there are actually 4 possible (endpointsMenuSettings.options.Sort.length). TODO: try with 4
    const directions = [
      bisect(endpointsMenuSettings.options.Sort[0][0], 0, 1)[1],
      bisect(endpointsMenuSettings.options.Sort[0][1], 0, 1)[1]
    ]
    const sortables = endpointsMenuSettings.options.Sort.map( option =>  option[0].slice(0,-2) );
    const preventSectionHell = perm => {
      const sliced = perm.slice(0,2).join('')
      const include = !perm.slice(0,2).join('').includes('Endpoint')
      // console.log(`${perm} = sliced: ${sliced} ? ${include}`)
      return include;
    }

    const sort_options_data = permuteChooseR(sortables, max_sorts, preventSectionHell).sort().reverse();;
    const direction_options_data = combinationsWithReps(directions,4);
    // console.log(direction_options_data)

    let sort_options_html = sort_options_data.map( sorts => {
      // const selected_by_default = 
      return `<option>`+sorts.join(' ')+`</option>`
    });

    let direction_options_html = direction_options_data.map(dirs => {
      return `<option>&nbsp;&nbsp;`+dirs.join('&nbsp;'.repeat(10))+`</option>`
    });
    // console.log(Array.isArray(sort_options_html))
    // console.log(direction_options_html)


    
    select.Sort_by.innerHTML = sort_options_html.join('\n');
    select.Sort_dir.innerHTML = direction_options_html.join('\n');

  }

  function appendShowOptions() {

    const {
      'Show.Category': categories,
      'Show.API': apis,
      'Show.Parameters.selections': params,
      'Show.Parameters.Require': params_require,
    } = endpointsMenuSettings.options

    const option = opt => `<option>${opt}</option>`

    select['Show.Category'].innerHTML = categories.map(opt => option(opt)).join('\n');
    select['Show.API'].innerHTML = apis.map(opt => option(opt)).join('\n');
    select['Show.Parameters.selections'].innerHTML = params.map(opt => option(opt)).join('\n');
    select['Show.Parameters.Require'].innerHTML = params_require.map(opt => option(opt)).join('\n');
  }
  
}

//// GLOBALS ////////////////////


// var endpoints_json = window.endpoints_json; // set in module.js

// all of these are set in endpoints.js:
var //endpointsMenuSettings = {},
    // selectEndpoints.endpoints = [], // this is endpoints_json.endpoints, filtered and sorted
    selected_URLs, // used cleaning up endpoints menu when selection is made
    responses, // really only used in async function handleClickGET, but could be used for showing errors better 
    rendered_json;  // combined GET responses as full object (no arrays)



class Get {

  get endpoints_get_list() {
    return this.log[this.log.length - 1];
  }
  async getAndDisplay(update_query_string=true) {
    return handleClickGET(...[,update_query_string]);
  }
  get responses() {
    return responses
  }
}


//// Start Execution ////////////////////

document.addEventListener("DOMContentLoaded", function() {



  refreshEndpointsMenuContents( /* selected */ ) // without arg, default become fallback_defaults

  makeEndpointsSelectors(4)
    
  makeEndpointsMenuCollapsible()
  setupEndpointsMenuSelection(addEndpointValidToGETList, addEndpointTemplateToGETList)
  makeListEditable(document.getElementById('endpoints_get_list'))


  parseQueryStringEndpoints(true, true)  


  document.getElementById('endpoints-get-submit').addEventListener('click', handleClickGET)

});
  
</script>
</body>
</html>